<link rel="import" href="../node_modules/ui-typeahead/src/ui-typeahead.html" />
<link rel="import" href="../node_modules/ui-tooltip/src/ui-tooltip.html" />
<link rel="import" href="../node_modules/core-ajax-npm/core-ajax.html">
<link rel="import" href="../node_modules/ui-pill/src/ui-pill.html" />
<link rel="import" href="safe-html.html" />

<polymer-element on-focus="{{focus}}" name="glg-taxonomy" attributes="type queryurl searchurl value placeholder debounce limit">
  <template>
    <link rel="stylesheet" type="text/css" href="./glg-taxonomy.less">

    <link rel="stylesheet" href="../node_modules/ui-fonts/node_modules/ui-font-awesome/font-awesome.less">
    <link rel="stylesheet" href="../node_modules/ui-fonts/node_modules/ui-font-awesome/icons.less">

      <ui-typeahead id="typeahead" placeholder="{{placeholder}}" sticky="always">
        <icon hidden?="{{loading == false}}" spinner class="spin"></icon>
        <icon hidden?="{{loading == true}}" search></icon>
        <template value="{{value}}">
          <value on-click="{{browse}}">
            <ui-tooltip label="{{item.fullPath}}">
              <ui-pill>{{item.nodeName}}</ui-pill>
            </ui-tooltip>
          </value>
        </template>

        <template if="{{termMatched === false}}">
          <ui-typeahead-section>
            Nothing matched
          </ui-typeahead-section>
        </template>

        <template if="{{showBrowse}}">
          <ui-typeahead-section>
            <template repeat="{{ branch, b in branches}}">
              <span on-click="{{nop}}" class="tree-branch">
                <icon angle-down></icon>
                <select on-change="{{filter}}">
                  <template repeat="{{ option in branch}}">
                    <option selected?="{{selectedItems[b].id == option.id}}" value="{{option.id}}">{{option.nodeName}}</option>
                  </template>
                </select>
                <icon on-click="{{select}}" plus></icon>
              </span>
            </template>
          </ui-typeahead-section>
        </template>

        <template id="typeahead-template" repeat="{{item, i in items}}">
          <ui-typeahead-item class="{{ {'odd': i % 2 == 0 } | tokenList }}" focused?="{{item.focused}}">
            <span on-click="{{browse}}">
              <icon folder-open-o hidden?="{{item.closed}}"></icon>
              <icon folder-o hidden?="{{!item.closed}}"></icon>
            </span>
            <safe-html html="{{ item.highlight }}"></safe-html>
          </ui-typeahead-item>
        </template>

      </ui-typeahead>

      <core-ajax id="queryXhr" method="post" url="{{queryurl}}" contentType="application/json" handleAs="json" on-core-response="{{handleQueryResponse}}">
      </core-ajax>
      <core-ajax id="searchXhr" method="post" url="{{searchurl}}" contentType="application/json" handleAs="json" on-core-response="{{handleSearchResponse}}">
      </core-ajax>

  </template>
  <script src="./glg-taxonomy.litcoffee"></script>
</polymer-element>
